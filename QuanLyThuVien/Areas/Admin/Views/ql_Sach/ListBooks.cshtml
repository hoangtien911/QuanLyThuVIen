@model QuanLyThuVien.Models.Books

@{
    ViewBag.Title = "Danh sách sách";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}
<!-- PAGE BODY-->
<div class="page-title">
    <div class="row">
        <div class="col-12 col-md-6 order-md-1 order-last">
            <nav aria-label="breadcrumb" class='breadcrumb-header'>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#">Quản lý sách</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Danh sách sách</li>
                </ol>
            </nav>
        </div>
    </div>
</div>

<section class="section">
    <div class="card">
        <div class="card-header row" style="margin-bottom: 10px;">
            <h3 class="col-6" style="margin-bottom: 0; margin-top: 4px; color: #fff;">@ViewBag.Title</h3>
            <div class="col-6 d-flex justify-content-end">
                <a class="btn icon icon-left btn-primary" onclick="ClearModal()" style="font-weight: bold; width: 200px; background-color:#0097ff; border-color: #fff">
                    <i data-feather="plus-square"></i>Thêm mới
                </a>
            </div>
        </div>
        <div class="card-body">
            <table class='table table-hover' id="table1">
                <thead>
                    <tr>
                        <th>Tên sách</th>
                        <th>Tác giả</th>
                        <th>Thể loại</th>
                        <th>Giới thiệu</th>
                        <th>Số sách còn</th>
                        <th>Ảnh bìa</th>
                        <th>Trạng thái</th>
                        <th>Tác vụ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in ViewBag.BooksList)
                    {
                        <tr>
                            <td style="width: 200px;">
                                <p>@item.title</p>
                            </td>
                            <td style="white-space: nowrap">
                                @{
                                    int i = 0;
                                    foreach (var authorName in item.author_temp)
                                    {
                                        if (i == 2)
                                        {
                                            <p>@authorName ...</p>
                                            break;
                                        }
                                        <p>@authorName</p>
                                        i++;
                                    }
                                }
                            </td>
                            <td style="width:150px; white-space: nowrap">
                                @{
                                    i = 0;
                                    foreach (var cateName in item.categories_temp)
                                    {
                                        if (i == 2)
                                        {
                                            <p>@cateName ...</p>
                                            break;
                                        }
                                        <p>@cateName</p>
                                        i++;
                                    }
                                }
                            </td>
                            <td style="width: 400px;">
                                <p>@item.shortDescription</p>
                            </td>
                            <td>
                                <p>@item.count_in</p>
                            </td>
                            <td>
                                <img src="@item.thumbnailUrl" style="height: 75px; width: 75px;" />
                            </td>
                            <td>
                                @switch (item.status)
                                {
                                    case "Còn sách":
                                        {
                                            <span class="badge bg-success">Còn sách</span>
                                            break;
                                        }
                                    case "Hết sách":
                                        {
                                            <span class="badge bg-danger">Hết sách</span>
                                            break;
                                        }
                                    case "Chưa cập nhật":
                                        {
                                            <span class="badge bg-light">Chưa cập nhật</span>
                                            break;
                                        }
                                }
                            </td>
                            <td class="link-action" style="min-width:135px; width: 135px;">                                
                                <a name="edit_link" class="link-edit" onclick="GetBook('@item._id')">
                                    <i class="fa fa-edit"></i> Sửa
                                </a><br />
                                <a name="delete_link" class="link-delete" onclick="GetBookDelete('@item._id')">
                                    <i class="fa fa-trash"></i> Xoá
                                </a><br />
                                <a name="detail_link" class="link-detail" href="@Url.Action("Detail", "ql_Sach" , new { id = item._id})">
                                    <i class="fa fa-info-circle"></i> Chi tiết
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- CREATE-EDIT MODAL -->
<div class="modal fade text-left w-100" id="Add_Edit_BookModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel16" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="Modal_title">Thêm mới sách</h4>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="FormAddBook">
                    <!--Row 1-->
                    <div class="row">
                        <div class="col-sm-6 mb-1" style="padding-right: 10px;">
                            <div class="input-group">
                                <span class="input-group-text">ID</span>
                                <input type="text" class="form-control" disabled="disabled" id="Add_id" />
                            </div>
                        </div>
                        <div class="col-sm-6 mb-1" style="padding-left: 10px;">
                            <div class="input-group">
                                <span class="input-group-text">Trạng thái</span>
                                <select class="form-control" id="Add_status">
                                    <option>Còn sách</option>
                                    <option>Hết sách</option>
                                    <option>Chưa cập nhật</option>
                                </select>
                            </div>
                            <p></p>
                        </div>
                    </div>
                    <!-- Row 2-->
                    <div class="row">
                        <div class="col mb-1">
                            <div class="input-group">
                                <span class="input-group-text">Tên sách *</span>
                                <input type="text" class="form-control" id="Add_title" />
                            </div>
                            <p></p>
                        </div>
                    </div>
                    <!-- Row 3-->
                    <div class="row mutil-choice">
                        <div class="col mb-1">
                            <div class="input-group">
                                <span class="input-group-text">Tác giả * </span>
                                <select class="form-control" id="Add_author" name="Add_author" multiple="multiple">
                                    @foreach (var author in ViewBag.listAuthor)
                                    {
                                        <option value="@author.id">@author.name</option>

                                    }
                                </select>
                            </div>
                        </div>
                        <p></p>
                    </div>
                    <!-- Row 4-->
                    <div class="row mutil-choice">
                        <div class="col mb-1">
                            <div class="input-group">
                                <span class="input-group-text">Thể loại * </span>
                                <select class="form-control" id="Add_cate" multiple="multiple">
                                    @foreach (var cate in ViewBag.listCategories)
                                    {
                                        <option value="@cate.id">@cate.name</option>

                                    }
                                </select>
                            </div>
                        </div>
                        <p></p>
                    </div>
                    <!-- Row 5-->
                    <div class="row">
                        <div class="col mb-1">
                            <div class="input-group">
                                <span class="input-group-text">Giới thiệu</span>
                                <textarea class="form-control" rows="3" style="resize: none;" id="Add_short"></textarea>

                            </div>
                            <p></p>
                        </div>
                    </div>
                    <!-- Row 6-->
                    <div class="row">
                        <div class="input-group" style="height: 400px">
                            <span class="input-group-text">Giới thiệu chi tiết</span>
                            <div style="flex: 1 1 auto; width: min-content;">
                                <div id="full_editor" style="height: 358px">
                                </div>
                                <textarea class="hide" id="Add_long"></textarea>
                            </div>
                        </div>
                        <p></p>
                    </div>
                    <!-- Row 7-->
                    <div class="row">
                        <div class="col-sm-6 mb-1" style="padding-right: 10px;">
                            <div class="input-group">
                                <span class="input-group-text">Năm xuất bản</span>
                                <input type="number" class="form-control" name="datepicker" id="Add_pubDate" />
                            </div>
                            <p></p>
                        </div>
                        <div class="col-sm-6 mb-1" style="padding-left: 10px;">
                            <div class="row">
                                <div class="col-sm-6" style="padding-right: 5px">
                                    <div class="input-group">
                                        <span class="input-group-text">Số lượng</span>
                                        <input type="number" class="form-control" id="Add_count" />
                                    </div>
                                </div>
                                <div class="col-sm-6" style="padding-left: 5px">
                                    <div class="input-group">
                                        <span class="input-group-text">Số sách còn</span>
                                        <input type="number" class="form-control" id="Add_countIn" disabled="disabled" />
                                    </div>
                                </div>
                            </div>
                            <p></p>
                        </div>
                    </div>
                    <!-- Row 8-->
                    <div class="row">
                        <input type="file" class="hide" accept="image/*" id="Add_Thumb_hide" />                      
                        <div class="col mb-1">
                            <div class="input-group">
                                <span class="input-group-text">Ảnh bìa</span>
                                <label class="form-control" style="background-color: white; overflow: hidden; text-overflow: ellipsis; " id="Add_thumb"></label>
                            </div>
                            <p></p>
                        </div>
                    </div>
                    <!---->
                    <p style="color:firebrick">Dấu (*) là bắt buộc.</p>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="ModalCancel">
                    <i class="bx bx-check d-block d-sm-none"></i>
                    <span class="d-none d-sm-block">Huỷ</span>
                </button>
                <button name="SaveBook" type="button" class="btn btn-primary ml-1" onclick="SaveBook()">
                    <i class="bx bx-check d-block d-sm-none"></i>
                    <span class="d-none d-sm-block">Lưu</span>
                </button>
            </div>
        </div>
    </div>
</div>
<!-- DELETE MODAL-->
<div class="modal fade text-left" id="Delete_Modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel120" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"
         role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h5 class="modal-title white" id="Delete_title">Bạn có muốn xoá sách này?</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close"><i data-feather="x"></i></button>
            </div>
            <div class="modal-body" id="Delete_modal_body">
                <p id="D_title"></p>
                <p id="D_ID" class="hide"></p>
                <ul>
                    <li id="D_author"></li>
                    <li id="D_cate"></li>
                    <li id="D_date"></li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">
                    <i class="bx bx-x d-block d-sm-none"></i>
                    <span class="d-none d-sm-block">Huỷ</span>
                </button>
                <button type="button" class="btn btn-danger ml-1" data-bs-dismiss="modal" onclick="DeleteBook()">
                    <i class="bx bx-check d-block d-sm-none"></i>
                    <span class="d-none d-sm-block">Xoá</span>
                </button>
            </div>
        </div>
    </div>
</div>
<!-- SCRIPTS-->
@section scripts{
    <script type="text/javascript">  
        $(function () {
            //Cấu hình toasts
            toastr.options = {
                "closeButton": true,
                "debug": false,
                "newestOnTop": true,
                "progressBar": true,
                "positionClass": "toast-top-right",
                "preventDuplicates": false,
                "onclick": null,
                "showDuration": "300",
                "hideDuration": "1000",
                "timeOut": "5000",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            }  
            //cấu hình chosen framework
            $("#Add_author").chosen({
                no_results_text: "Không tìm thấy tác giả",
                max_selected_options: 5
            });
            $("#Add_author").bind("chosen:maxselected", function () { alert("Chỉ được chọn nhiều nhất 5 tác giả."); });
            $("#Add_cate").chosen({
                no_results_text: "Không tìm thấy thể loại",
                max_selected_options: 5,
            });
            $("#Add_cate").bind("chosen:maxselected", function () { alert("Chỉ được chọn nhiều nhất 5 thể loại."); });
            $("#Add_status").chosen({
                disable_search: true
            });
        });
        //Chọn file ảnh
        $('#Add_thumb').on('click', function () {
            $('#Add_Thumb_hide').click();
        });
        var thumbSrc = ""
        $('#Add_Thumb_hide').on('change', function (e) {
            //lấy file
            var fff = e.target.files;
            var no_files = 0;
            if (fff !== undefined)
                no_files = fff.length;           

            $('#Add_thumb').empty();
            $('#Add_thumb').text(fff[no_files - 1].name);

            // Resize ảnh
            const resize_width = 600;
            const item = fff[no_files -1];
            const reader = new FileReader();
            reader.readAsDataURL(item);
            reader.name = item.name;
            reader.size = item.size;
            reader.onload = function (event) {
                const img = new Image();
                img.src = event.target.result;
                img.name = event.target.name;
                img.size = event.target.size;
                img.onload = function (el) {
                    const elem = document.createElement('canvas');
                    const scaleResize = resize_width / el.target.width;
                    elem.width = resize_width;
                    elem.height = el.target.height * scaleResize;
                    const ctx = elem.getContext('2d');
                    ctx.drawImage(el.target, 0, 0, elem.width, elem.height);
                    const srcEncoded = ctx.canvas.toDataURL('image/jpeg', 1);     

                    thumbSrc = srcEncoded;
                }
            }          
            ///            
        });
        //Tuỳ chỉnh datetime picker
        $(function () {
            $('#Add_pubDate').datepicker({
                format: "yyyy",
                viewMode: "years",
                minViewMode: "years",
                autoclose: true
            });
        });   
        //AJAX gửi dữ liệu tới controller
        function SaveBook() {
            document.getElementById("Add_long").value = quillEditor.root.innerHTML;           
            var bookData = {
                _id: $('#Add_id').val(),
                status: $('#Add_status').val(),
                title: $('#Add_title').val(),
                author_temp: $('#Add_author').val(),
                categories_temp: $('#Add_cate').val(),
                shortDescription: $('#Add_short').val(),
                longDescription: $('#Add_long').val(),
                count: $('#Add_count').val(),
                count_in: $('#Add_countIn').val(),
                publishedDate: $('#Add_pubDate').val(),
                thumbnailUrl: thumbSrc
            }         
            $.ajax({
                url: "/Admin/ql_Sach/Create_Edit",
                data: JSON.stringify(bookData),
                type: "POST",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (res) {
                    if (res.status != null) {
                        {
                            if (res.status == "ADD_OK") {
                                $('#ModalCancel').click();                                
                                toastr["success"]("Thêm mới sách: " + bookData.title + " thành công!", "Thêm mới thành công");    
                                $("#body_build").load(" #body_build > *");
                                //window.location.reload(true);
                            }
                            if (res.status == "EDIT_OK") {
                                $('#ModalCancel').click();
                                $("#body_build").load(" #body_build > *");
                                toastr["success"]("Sửa thông tin sách: " + bookData.title + " thành công!", "Sửa thông tin thành công");                                
                            }
                            if (res.status == "ADD_FALSE") {
                                toastr["warning"]("Sách: " + bookData.title + " đã có trong hệ thống!", "Thêm mới thất bại");
                            }
                            if (res.status == "EDIT_FALSE") {
                                toastr["warning"]("Sách: " + bookData.title + " đã có trong hệ thống!", "Sửa thông tin thất bại");                              
                            }
                            if (res.status == "NO_INPUT_DATA") {                             
                                toastr["error"](res.propery + " chưa được nhập!", "Lưu thất bại");                               
                            }
                        }
                    }
                },
                error: function () {
                    alert("Đã có lỗi xảy ra. Kiểm tra lại kết nối mạng hoặc tải lại trang.");
                    toastr["error"]("Đã có lỗi xảy ra. Kiểm tra lại kết nối mạng hoặc tải lại trang!", "Lỗi");                    
                }
            });
        };
        //Setup edit modal
        function GetBook(id) {
            $.ajax({
                type: "GET",
                url: "/Admin/ql_Sach/GetBook/" + id,
                dataType: "json",
                success: function (res) {
                    $('#Add_id').val(res._id);
                    $('#Add_status').val(res.status).trigger('chosen:updated');
                    $('#Add_title').val(res.title);
                    $('#Add_author').val(res.author_temp).trigger('chosen:updated');
                    $('#Add_cate').val(res.categories_temp).trigger('chosen:updated');
                    $('#Add_short').val(res.shortDescription);
                    $('#Add_long').val("");
                    quillEditor.root.innerHTML = res.longDescription;
                    $('#Add_count').val(res.count);
                    $('#Add_countIn').val(res.count_in);
                    $('#Add_countIn').removeAttr("disabled");
                    $('#Add_pubDate').val(res.publishedDate);
                    $('#Add_thumb').empty();
                    $('#Add_thumb').text(res.thumbnailUrl);
                    thumbSrc = res.thumbnailUrl;
                    $('#Add_Edit_BookModal').modal('show');
                }
            })
        };
        //setup create modal
        function ClearModal() {
            $('#Add_id').val("");
            $('#Add_status').val("Còn sách").trigger('chosen:updated');
            $('#Add_title').val("");
            $('#Add_author').val("").trigger('chosen:updated');
            $('#Add_cate').val("").trigger('chosen:updated');
            $('#Add_short').val("");
            $('#Add_long').val("");
            quillEditor.root.innerHTML = "";
            $('#Add_count').val("");
            $('#Add_countIn').val("");
            $('#Add_countIn').attr('disabled', 'disabled');
            $('#Add_pubDate').val("");
            $('#Add_Thumb').empty;
            $('#Add_thumb').text("");
            $('#Add_Thumb_hide').val("");
            $('#Add_Edit_BookModal').modal('show');

        };
        //Setup delete modal
        function GetBookDelete(id) {
            $.ajax({
                type: "GET",
                url: "/Admin/ql_Sach/GetBookDelete/" + id,
                dataType: "json",
                success: function (res) {
                    document.getElementById("D_ID").innerHTML = res._id;

                    document.getElementById("D_title").innerHTML = "Sách: " + res.title;
                    document.getElementById("D_author").innerHTML = "Tác giả: " + res.author_temp.join(',');
                    document.getElementById("D_cate").innerHTML = "Thể loại: " + res.categories_temp.join(',');
                    document.getElementById("D_date").innerHTML = "Năm xuất bản: " + res.publishedDate;
                    $('#Delete_Modal').modal('show');
                }
            })
        };
        //Delete book
        function DeleteBook() {
            var id = document.getElementById("D_ID").innerHTML;
            $.ajax({
                type: "POST",
                url: "/Admin/ql_Sach/Delete/" + id,
                dataType: "json",
                success: function (res) {
                    if (res.status == "DELETE_OK") {                                      
                        //window.location.reload(true);
                        $("#body_build").load(" #body_build > *");
                        toastr["success"]("Sách đã được xoá!", "Xoá thành công");
                        

                    }
                    if (res.status == "DELETE_FALSE") {                       
                        toastr["error"]("Xoá thất bại. Kiểm tra lại kết nối mạng hoặc tải lại trang!", "Xoá thất bại");   
                    }
                }
            })
        };
    </script>
}